{% extends "base.html" %}

{% block title %}Photobooth{% endblock %}

{% block content %}
<div class="container-fluid p-3" style="height: 100vh; overflow: hidden; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: #1a1a1a;">
    <style>
    /* Ajustements spécifiques pour les petits écrans 800x480 */
    @media (max-width: 800px) and (max-height: 480px) {
        #videoContainer {
            height: calc(100vh - 1rem);
            width: calc(100vw - 1rem);
        }

        #videoPreview {
            max-width: calc(100vw - 1rem);
            max-height: calc(100vh - 1rem);
        }

        #captureBtn {
            font-size: 1.2rem;
            padding: 8px 16px;
        }
    }

    #captureBtn {
        animation: pulse 2s infinite;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(45deg, #ff416c, #ff4b2b);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    #captureBtn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 25px rgba(0,0,0,0.5);
    }

    #captureBtn:disabled {
        animation: none;
        opacity: 0.6;
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 4px 25px rgba(0,0,0,0.5);
        }
    }

    #processingOverlay {
        background-color: rgba(0,0,0,0.85);
    }

    #animationEmoji {
        font-size: 150px;
        display: none;
    }

    @keyframes emoji-bounce {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
    }
    </style>
    <!-- Conteneur vidéo avec marges élégantes -->
    <div class="video-container position-relative d-flex align-items-center justify-content-center" id="videoContainer" style="height: calc(100vh - 2rem); width: calc(100vw - 2rem);">
        <img id="videoPreview" 
             src="{{ url_for('video_stream') }}" 
             style="max-width: calc(100vw - 2rem); max-height: calc(100vh - 2rem); width: auto; height: auto; object-fit: contain; background-color: #000; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);"
             alt="Flux vidéo caméra">
        
        <!-- Countdown overlay -->
        <div class="countdown d-none position-absolute top-50 start-50 translate-middle" id="countdown"></div>
        
        <!-- Flash blanc pour la prise de photo -->
        <div class="flash-overlay d-none position-fixed top-0 start-0 w-100 h-100" id="flashOverlay"
             style="background-color: white; z-index: 15;"></div>

        <!-- Punchline overlay -->
        <div id="punchlineOverlay" class="d-none position-fixed w-100 text-center" style="z-index: 30; pointer-events: none;">
            <div id="punchlineText" style="display:inline-block; margin:auto; font-size:2rem; font-weight:bold; color:white; text-shadow:0 0 10px black;"></div>
        </div>

        <!-- Animation overlay -->
        <div id="animationOverlay" class="d-none position-fixed" style="z-index:40; pointer-events:none;">
            <img id="animationImage" src="" alt="Animation" style="width:150px;height:auto; display:none;" />
            <div id="animationEmoji"></div>
        </div>

        <!-- Bouton capture en overlay -->
        <div class="position-absolute bottom-0 start-50 translate-middle-x mb-4" style="z-index: 5;">
            <button id="captureBtn" class="btn" onclick="capturePhoto()">
                <i class="fas fa-camera"></i>
            </button>
        </div>
    </div>
    
    <!-- Alerte manque de papier -->
    <div class="position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 20; width: 90%; max-width: 500px;">
        <div class="alert alert-warning d-none d-flex align-items-center" id="paper-alert" style="border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <div>
                <strong>Attention !</strong><br>
                <small>Vérifiez le papier de l'imprimante avant de prendre une photo</small>
            </div>
        </div>
    </div>
</div>

<!-- Overlay de traitement -->
<div id="processingOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="z-index: 2000;">
    <div class="text-center text-white">
        <div class="mb-4"><i class="fas fa-spinner fa-spin" style="font-size: 4rem;"></i></div>
        <h2 class="mb-0">Traitement en cours...</h2>
    </div>
</div>

<!-- Overlay diaporama -->
<div id="slideshowOverlay" class="d-none" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div class="slideshow-container" style="width: 100%; height: 100%; position: relative;">
        <img id="slideshowImage" 
             style="width: 100%; height: 100%; object-fit: contain;" 
             alt="Photo du diaporama">
        
        <!-- Indicateur de progression -->
        <div class="slideshow-info position-absolute bottom-0 start-0 end-0 p-4 text-white" style="background: linear-gradient(transparent, rgba(0,0,0,0.7));">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1" id="slideshowTitle">Diaporama</h5>
                    <small id="slideshowCounter">Photo 1 sur 10</small>
                </div>
                <div class="text-end">
                    <small class="text-muted">Appuyez sur l'écran pour revenir</small>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const boothConfig = {{ booth_config | tojson | safe }};
let isCapturing = false;

// Initialiser la caméra au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    initCamera();
});

function initCamera() {
    try {
        console.log('Initialisation du flux vidéo caméra...');
        
        const videoPreview = document.getElementById('videoPreview');
        
        // Gérer les erreurs de chargement du flux
        videoPreview.onerror = function() {
            console.error('Erreur de chargement du flux vidéo');
            showCameraError();
        };
        
        // Gérer le chargement réussi
        videoPreview.onload = function() {
            console.log('Flux vidéo caméra démarré avec succès');
        };
        
        // Démarrer le flux via l'API
        fetch('/start_camera')
            .then(response => response.json())
            .then(data => {
                console.log('Caméra initialisée:', data.status);
            })
            .catch(error => {
                console.error('Erreur d\'initialisation caméra:', error);
            });
        
    } catch (error) {
        console.error('Erreur d\'accès à la caméra:', error);
        showCameraError();
    }
}

function showCameraError() {
    document.getElementById('videoContainer').innerHTML = 
        '<div class="alert alert-warning m-3">' +
        '<i class="fas fa-exclamation-triangle me-2"></i>' +
        'Impossible d\'accéder à la caméra. Vérifiez que libcamera est installé et que la caméra est connectée.' +
        '</div>';
}

function capturePhoto() {
    if (isCapturing) return;
    
    isCapturing = true;
    const captureBtn = document.getElementById('captureBtn');
    const countdown = document.getElementById('countdown');
    
    // Désactiver le bouton
    captureBtn.disabled = true;
    captureBtn.innerHTML = '<i class="fas fa-spinner fa-spin fa-2x"></i>';
    
    // Démarrer le compte à rebours
    let timeLeft = parseInt('{{ timer }}');
    countdown.classList.remove('d-none');
    
    const countdownInterval = setInterval(() => {
        countdown.textContent = timeLeft;
        timeLeft--;

        if (timeLeft < 0) {
            clearInterval(countdownInterval);
            countdown.classList.add('d-none');

            const phrase = getRandomPhrase();

            // Déclencher le flash blanc rapidement
            const flashOverlay = document.getElementById('flashOverlay');
            flashOverlay.classList.remove('d-none');
            setTimeout(() => {
                flashOverlay.classList.add('d-none');
            }, 100);

            // Prendre la photo immédiatement
            takePicture();

            // Afficher la punchline
            showPunchline(phrase);
        }
    }, 1000);
}

function getRandomPhrase() {
    const phrases = boothConfig.phrases || [];
    if (!phrases.length) return 'Souris !';
    const index = Math.floor(Math.random() * phrases.length);
    return phrases[index];
}

function showPunchline(text) {
    const overlay = document.getElementById('punchlineOverlay');
    const textDiv = document.getElementById('punchlineText');

    // Positioning
    overlay.style.left = '50%';
    overlay.style.transform = 'translateX(-50%)';
    if (boothConfig.display && boothConfig.display.position === 'bottom') {
        overlay.style.top = '';
        overlay.style.bottom = '10%';
    } else {
        overlay.style.bottom = '';
        overlay.style.top = '50%';
        overlay.style.transform = 'translate(-50%, -50%)';
    }

    textDiv.textContent = text;
    overlay.classList.remove('d-none');

    // Optional sound
    if (boothConfig.sound && boothConfig.sound.enabled) {
        try {
            const audio = new Audio(boothConfig.sound.asset || 'static/assets/punch.mp3');
            audio.volume = Math.min(0.5, audio.volume);
            audio.play().catch(() => {});
        } catch (e) {
            console.log('Sound error', e);
        }
    }

    setTimeout(() => {
        overlay.classList.add('d-none');
        maybeShowAnimation();
    }, (boothConfig.display && boothConfig.display.durationMs) || 1500);
}

function maybeShowAnimation() {
    const anim = boothConfig.animation || {};
    if (!anim.enabled) return;
    if (Math.random() >= (anim.probability || 0)) return;

    const assets = anim.assets || [];
    if (!assets.length) return;
    const asset = assets[Math.floor(Math.random() * assets.length)];

    const overlay = document.getElementById('animationOverlay');
    const img = document.getElementById('animationImage');
    const emojiDiv = document.getElementById('animationEmoji');
    img.style.display = 'none';
    emojiDiv.style.display = 'none';

    if (asset.startsWith('emoji:')) {
        emojiDiv.textContent = asset.slice(6);
        emojiDiv.style.animation = `emoji-bounce ${(anim.durationMs || 800)}ms ease`;
        overlay.style.top = '50%';
        overlay.style.left = '50%';
        overlay.style.transform = 'translate(-50%, -50%)';
        overlay.classList.remove('d-none');
        emojiDiv.style.display = 'block';
        setTimeout(() => {
            overlay.classList.add('d-none');
            emojiDiv.style.display = 'none';
        }, anim.durationMs || 800);
        return;
    }

    img.onload = () => {
        overlay.style.top = '50%';
        overlay.style.left = '50%';
        overlay.style.transform = 'translate(-50%, -50%)';
        overlay.classList.remove('d-none');
        img.style.display = 'block';
        setTimeout(() => {
            overlay.classList.add('d-none');
            img.style.display = 'none';
        }, anim.durationMs || 800);
    };
    img.onerror = () => {
        console.log('Animation asset missing:', asset);
    };
    img.src = asset;
}

async function takePicture() {
    const overlay = document.getElementById('processingOverlay');
    overlay.classList.remove('d-none');
    overlay.style.display = 'flex';
    try {
        const response = await fetch('/capture', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Rediriger vers la page de révision
            window.location.href = '/review';
        } else {
            throw new Error(result.error || 'Erreur de capture');
        }
        
    } catch (error) {
        console.error('Erreur lors de la capture:', error);
        alert('Erreur lors de la prise de photo: ' + error.message);

        overlay.classList.add('d-none');
        overlay.style.display = 'none';
        resetCaptureButton();
    }
}

function resetCaptureButton() {
    isCapturing = false;
    const captureBtn = document.getElementById('captureBtn');
    captureBtn.disabled = false;
    captureBtn.innerHTML = '<i class="fas fa-camera fa-2x"></i>';
    const overlay = document.getElementById('processingOverlay');
    overlay.classList.add('d-none');
    overlay.style.display = 'none';
}

// Variables pour le diaporama
let slideshowConfig = null;
let slideshowPhotos = [];
let slideshowActive = false;
let slideshowIndex = 0;
let slideshowInterval = null;

let inactivityTimer = null;
let lastActivity = Date.now();

// Initialiser le diaporama au chargement
document.addEventListener('DOMContentLoaded', function() {
    loadSlideshowConfig();
    setupActivityTracking();
});

async function loadSlideshowConfig() {
    try {
        const response = await fetch('/api/slideshow');
        slideshowConfig = await response.json();
        
        if (slideshowConfig.enabled && slideshowConfig.photos.length > 0) {
            slideshowPhotos = slideshowConfig.photos;
            startInactivityTimer();
        }
    } catch (error) {
        console.error('Erreur chargement config diaporama:', error);
    }
}

function setupActivityTracking() {
    // Détecter l'activité utilisateur
    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
        document.addEventListener(event, resetInactivityTimer, true);
    });
}

function resetInactivityTimer() {
    lastActivity = Date.now();
    
    if (slideshowActive) {
        // Si le diaporama est actif, le fermer
        stopSlideshow();
        return;
    }
    
    // Redémarrer le timer d'inactivité
    if (inactivityTimer) {
        clearTimeout(inactivityTimer);
    }
    
    if (slideshowConfig && slideshowConfig.enabled && slideshowPhotos.length > 0) {
        startInactivityTimer();
    }
}

function startInactivityTimer() {
    if (inactivityTimer) {
        clearTimeout(inactivityTimer);
    }
    
    inactivityTimer = setTimeout(() => {
        if (!slideshowActive && slideshowPhotos.length > 0) {
            startSlideshow();
        }
    }, slideshowConfig.delay * 1000);
}

function startSlideshow() {
    if (slideshowPhotos.length === 0) return;
    
    slideshowActive = true;
    slideshowIndex = 0;
    
    const overlay = document.getElementById('slideshowOverlay');
    overlay.classList.remove('d-none');
    overlay.style.display = 'flex';
    
    // Ajouter l'événement de clic pour fermer
    overlay.addEventListener('click', stopSlideshow);
    
    showCurrentSlide();
    
    // Démarrer la rotation automatique (5 secondes par photo)
    slideshowInterval = setInterval(() => {
        nextSlide();
    }, 5000);
    

}

function stopSlideshow() {
    slideshowActive = false;
    
    const overlay = document.getElementById('slideshowOverlay');
    overlay.classList.add('d-none');
    overlay.style.display = 'none';
    
    // Nettoyer les intervals
    if (slideshowInterval) {
        clearInterval(slideshowInterval);
        slideshowInterval = null;
    }
    

    
    // Redémarrer le timer d'inactivité
    startInactivityTimer();
}

function showCurrentSlide() {
    if (slideshowPhotos.length === 0) return;
    
    const image = document.getElementById('slideshowImage');
    const counter = document.getElementById('slideshowCounter');
    
    image.src = `/photos/${slideshowPhotos[slideshowIndex]}`;
    counter.textContent = `Photo ${slideshowIndex + 1} sur ${slideshowPhotos.length}`;
    

}

function nextSlide() {
    slideshowIndex = (slideshowIndex + 1) % slideshowPhotos.length;
    showCurrentSlide();

}



// Vérifier le statut de l'imprimante pour l'alerte papier
function checkPrinterPaperStatus() {
    fetch('/api/printer_status')
        .then(response => response.json())
        .then(data => {
            const paperAlert = document.getElementById('paper-alert');
            
            // Afficher l'alerte seulement si l'imprimante est activée et qu'il y a un problème de papier
            if (data.status === 'ok' && data.paper_status && data.paper_status !== 'ok' && data.paper_status !== 'unknown') {
                paperAlert.classList.remove('d-none');
            } else {
                paperAlert.classList.add('d-none');
            }
        })
        .catch(error => {
            console.error('Erreur vérification papier:', error);
            // Masquer l'alerte en cas d'erreur
            document.getElementById('paper-alert').classList.add('d-none');
        });
}

// Vérifier le papier au chargement et périodiquement
document.addEventListener('DOMContentLoaded', function() {
    // Vérifier si on doit forcer l'affichage de l'alerte papier
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('show_paper_alert') === '1') {
        // Forcer l'affichage de l'alerte
        const paperAlert = document.getElementById('paper-alert');
        paperAlert.classList.remove('d-none');
        
        // Nettoyer l'URL sans recharger la page
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
    
    checkPrinterPaperStatus();
    // Vérifier toutes les 30 secondes
    setInterval(checkPrinterPaperStatus, 30000);
});

// Nettoyer les ressources lors de la fermeture
window.addEventListener('beforeunload', function() {
    fetch('/stop_camera').catch(error => {
        console.log('Erreur arrêt caméra:', error);
    });
});
</script>
{% endblock %}
